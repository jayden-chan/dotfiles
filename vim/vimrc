set nocompatible

filetype off

" Plugins

    call plug#begin('~/.local/share/nvim/plugged')

    " Theme
        Plug 'morhetz/gruvbox'
        Plug 'Yggdroot/indentline'
        Plug 'vim-airline/vim-airline'

    " fs nav
        Plug 'scrooloose/nerdtree'
        Plug 'junegunn/fzf'
        Plug 'junegunn/fzf.vim'

    " Git
        Plug 'airblade/vim-gitgutter'
        Plug 'tpope/vim-fugitive'
        Plug 'tpope/vim-rhubarb'

    " Util
        Plug 'godlygeek/tabular'

    " IDE-like
        Plug 'neoclide/coc.nvim', {'do': './install.sh nightly'}
        " Plugins
        " -------
        " coc-tsserver
        " coc-rls
        " coc-json
        " coc-eslint

        Plug 'jiangmiao/auto-pairs'
        Plug 'tpope/vim-commentary'
        Plug 'tpope/vim-surround'
        Plug 'gcmt/taboo.vim'
        Plug 'prettier/vim-prettier', { 'do': 'npm install' }

        Plug 'MarcWeber/vim-addon-mw-utils'
        Plug 'tomtom/tlib_vim'
        Plug 'garbas/vim-snipmate'

    " Syntax
        Plug 'plasticboy/vim-markdown'
        Plug 'tiagofumo/vim-nerdtree-syntax-highlight'
        Plug 'HerringtonDarkholme/yats.vim', { 'for': ['typescript'] }
        Plug 'pangloss/vim-javascript'
        Plug 'styled-components/vim-styled-components', { 'branch': 'main' }
        Plug 'mxw/vim-jsx'
        Plug 'mboughaba/i3config.vim'
        Plug 'jparise/vim-graphql'
        Plug 'rust-lang/rust.vim'

    call plug#end()

" Behaviour

    " Theme
    syntax enable

    " 256 colors
    set t_Co=256
    set t_ut=
    set termguicolors

    set guifont=Hack:h12

    " Set dark gruvbox theme
    set background=dark

    " gruvbox settings
    let g:gruvbox_contrast_dark='hard'
    let g:gruvbox_sign_column='bg0'
    let g:gruvbox_italic=1
    let g:gruvbox_bold=1
    let g:gruvbox_underline=1
    let g:gruvbox_invert_selection=0
    let g:gruvbox_italicize_strings=1

    colorscheme gruvbox

    " Tab settings
    set expandtab
    set shiftwidth=4
    set softtabstop=4
    set tabstop=4
    set smarttab
    set smartindent

    " Use backspace
    set backspace=indent,eol,start

    " Search settings
    set gdefault           " Global by default
    set ignorecase         " Ignore case
    set smartcase          " Override ignorecase if search contains capitals
    set incsearch          " Search incrementally
    set nohls              " Don't highlight after Enter is pressed
    set inccommand=nosplit " Show find/replace as it is typed

    " Open new splits on the right
    set splitright

    " Fold settings
    set foldlevel=1000
    set foldmethod=indent

    set undolevels=9001
    set cursorline

    " No command bar
    set noshowmode

    " Hide ugly completion messages
    set shortmess+=c

    " Don't let the cursor reach the top/bottom 8 lines of text
    set scrolloff=8

    " Don't automatically update working dir
    set noautochdir

    " Don't open preview windows
    set completeopt-=preview

    " Set .tex files to LaTeX syntax
    let g:tex_flavor="latex"

    " Unix file line endings
    set fileformat=unix

    " Make LaTeX live preview smoother
    set updatetime=300

    " Enable mouse
    set mouse=a

    " Change cursor to bar and underscore for different modes
    let &t_SI = "\<Esc>[6 q"
    let &t_SR = "\<Esc>[4 q"
    let &t_EI = "\<Esc>[2 q"

" Binds

    " Leader
    let mapleader = "\<Space>"

    " Relative line number toggle, toggle w/ F9
    set number relativenumber
    map <F9> <Esc>:set rnu!<CR>

    " Reload vimrc
    map <leader>ss :so $MYVIMRC<CR>

    " Map Ctrl-s to save
    nmap <c-s> :wa<CR>
    imap <c-s> <Esc>:wa<CR>

    " Spell check
    map <F6> :setlocal spell! spelllang=en_us<CR>
    set spellfile=$HOME/.config/nvim/spell/en.utf-8.add

    " Make Esc work in terminal mode, but not for fzf or rg
    tnoremap <Esc> <C-\><C-n>
    autocmd FileType fzf tnoremap <buffer> <Esc> <Esc>

    " ez semicolons & commas (perhaps the greatest binds in this entire config)
    inoremap ;; <Esc>A;
    nnoremap ;; <Esc>A;<Esc>
    inoremap ,, <Esc>A,
    nnoremap ,, <Esc>A,<Esc>

    " Formatting (remove whitespace and reindent)
    noremap <leader>ww :%s/\s\+$//e<CR>
    noremap <leader>tt mtgg=G`tzz

    " Close quickfix/preview/location
    noremap <silent> <c-q> :ccl<bar>pcl<bar>lcl<CR>

    " Fuzzy finding
    nnoremap <silent> <leader>f :FZ<CR>
    nnoremap <silent> <leader>r :Rg<CR>

    " Remap cursor movement keys because I'm a scrub and don't use the default
    noremap h i
    noremap j h
    noremap k gj
    noremap i gk

    " Various other cursor control maps
    noremap L g$
    noremap J g^
    noremap I 12<c-u>
    noremap K 12<c-d>
    nnoremap <leader>c J

    " Split line, inverse of J
    nnoremap <leader>C i<CR><esc>k:s/\s\+$//e<CR>j:noh<CR>

    " Open a new terminal window
    nnoremap <leader>e :below new<bar>terminal<CR>

    " F10 shows the color group of the symbol below the cursor
    map <F10> :echo "hi<" . synIDattr(synID(line("."),col("."),1),"name") . '> trans<'
    \ . synIDattr(synID(line("."),col("."),0),"name") . "> lo<"
    \ . synIDattr(synIDtrans(synID(line("."),col("."),1)),"name") . ">"<CR>

    " Change splits
    nnoremap <leader>j <C-w>h
    nnoremap <leader>k <C-w>j
    nnoremap <leader>i <C-w>k
    nnoremap <leader>l <C-w>l

    " Move the cursor more easily while in insert mode
    inoremap <c-j> <Left>
    inoremap <c-l> <Right>

    " Easily resize splits
    nnoremap <c-i> :resize -2<CR>
    nnoremap <c-k> :resize +2<CR>
    nnoremap <c-j> :vertical resize +5<CR>
    nnoremap <c-l> :vertical resize -5<CR>

    " Make c-p function like c-i since c-i was previously remapped
    nnoremap <c-p> <c-i>

    " Disable Ex mode
    map q: <nop>
    map Q <nop>

    " Used for centering text in the 'thicc' comments
    map <c-m> ^f*a<Space><Esc>f*h<Space><Esc>^

    " New line no insert mode
    map go o<Esc>

    " Copy Paste etc from system clipboard
    map <silent> <leader>p "+p
    map <silent> <leader>y "+y

    " Delete line without filling yank buffer
    nnoremap <silent> <leader>dd "_dd
    vnoremap <silent> <leader>dd "_dd

    " Prevent x and c from filling buffer
    noremap x "_x
    noremap c "_c
    noremap cc "_cc

    " Tab switching
    nmap <silent> <tab>j :tabprevious<CR>
    nmap <silent> <tab>l :tabnext<CR>

    " Fix 'I' behaviour in V-block
    vnoremap H I

" Plugin specific settings

    let g:snipMate = get(g:, 'snipMate', {})
    let g:snipMate = {}
    let g:snipMate.no_default_aliases = 1

    let g:airline_powerline_fonts = 1
    let g:airline_section_c = '%t'

    let NERDTreeMapOpenSplit='h'
    map <c-n> :NERDTreeToggle<CR>
    let g:NERDTreeFileExtensionHighlightFullName = 1
    let g:NERDTreeExactMatchHighlightFullName = 1
    let g:NERDTreePatternMatchHighlightFullName = 1
    let NERDTreeAutoDeleteBuffer = 1

    let g:prettier#autoformat = 0
    autocmd BufWritePre *.js,*.jsx,*.mjs,*.ts,*.tsx,*.json, PrettierAsync

    let g:javascript_plugin_jsdoc = 1

    " Set git-gutter column to always on
    set signcolumn=yes
    let g:gitgutter_map_keys = 0

    nnoremap <silent> ]c :GitGutterNextHunk<CR>
    nnoremap <silent> [c :GitGutterPrevHunk<CR>
    nnoremap <leader>u   :GitGutterUndoHunk<CR>

    let g:goyo_width = 120

    let g:indentLine_char = 'â”‚'

    let g:rustfmt_autosave = 1

    nmap <silent> ]e <Plug>(coc-diagnostic-next)
    nmap <silent> [e <Plug>(coc-diagnostic-prev)
    nmap <silent> <leader>o <Plug>(coc-definition)
    nmap <silent> <leader>O :vs<CR><Plug>(coc-definition)
    nmap <silent> <leader>n <Plug>(coc-references)
    nmap <silent> <leader>R <Plug>(coc-rename)

    nnoremap <silent> <leader>I :CocList diagnostics<CR>
    nnoremap <silent> <leader>b :CocList -I symbols<CR>

    " Show documentation in preview window
    nnoremap <silent> <leader>i :call <SID>show_documentation()<CR>

    function! s:show_documentation()
        if (index(['vim','help'], &filetype) >= 0)
            execute 'h '.expand('<cword>')
        else
            call CocAction('doHover')
        endif
    endfunction

    " Prevent coc from auto assigning these to stupid binds
    vmap <silent> <leader>F13 <Plug>(coc-funcobj-i)
    vmap <silent> <leader>F14 <Plug>(coc-funcobj-a)
    omap <silent> <leader>F15 <Plug>(coc-funcobj-i)
    omap <silent> <leader>F16 <Plug>(coc-funcobj-a)

    let g:rustfmt_autosave = 1

    let $FZF_DEFAULT_COMMAND = 'rg --files'

    let g:tex_conceal = ''

" Commands

    " Make leaving easier in case of typos
    command! -bang Q :q<bang>
    command! Wq :wq
    command! WQ :wq
    command! Wqa :wqa
    command! WQa :wqa
    command! WQA :wqa
    command! -bang Qa :qa<bang>
    command! -bang QA :qa<bang>

    command! RustDocs :silent !rustup doc --std

    " Remove all spaces and newlines
    command! Minify :%s/\s// | :%s/\n//

    " Mirror NERDTree when file is opened in new window
    autocmd BufWinEnter *.* silent NERDTreeMirror

    " Enable spell check for certain file types
    autocmd FileType gitcommit,text,markdown,tex setlocal spell

    " Set a max line length for LaTeX and Markdown files
    autocmd FileType markdown,tex setlocal textwidth=89
    autocmd FileType markdown,tex setlocal colorcolumn=90

    " Set indentation to 2 spaces for certain files
    autocmd FileType javascript,typescript,html,css,json,sql setlocal shiftwidth=2
    autocmd FileType javascript,typescript,html,css,json,sql setlocal softtabstop=2

    " Enter insert mode automatically when entering terminal
    autocmd BufWinEnter,WinEnter term://* startinsert

    " Set indentation to hard tabs for some files
    autocmd FileType snippets,go setlocal tabstop=4
    autocmd FileType snippets,go setlocal shiftwidth=4
    autocmd FileType c,asm       setlocal shiftwidth=8
    autocmd FileType c,asm       setlocal expandtab
    autocmd FileType go          setlocal noexpandtab

    " Easily open corresponding source file (C/C++)
    autocmd FileType c,cpp nmap <silent> <leader>vv :vs ../src/%<.*<CR>

    " Don't auto continue single line comments (//)
    autocmd FileType c,cpp,javascript,typescript,go,rust setlocal comments-=:// comments+=f://

" Abbreviations

    iab retrun   return
    iab retnru   return
    iab erturn   return
    iab ertnru   return
    iab thsi     this
    iab fcuntoin function
    iab fucntion function
    iab funcotin function
    iab funcoitn function
    iab funciton function
    iab costn    const
    iab conts    const
    iab THe      The
    iab THis     This
    iab !+       !=
    iab +>       =>
